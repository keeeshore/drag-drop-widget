<!DOCTYPE html> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!--- 

CODE ASSUMPTIONS:
 
 1. latest version of browsers (IE , Firefox, Chrome) with HTML 5 support (HTML 5 - optional).
 2. Jquery is required (cached or will be downloaded from google).
 3. Javascript must be enabled (mandatory).
 
 HTML/JAVASCRIPT CONDITIONS:
 
 1. Mandatory class name is needed as follows:
	a. "coloumn" classname needs to present for each coloumn.
	b. "widgetDIV" needs to be present for each widget section.
	c. <h1> needs to present inside every div with classname "widgetDIV".

--->

<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
	<link rel="stylesheet" href="global-tw.css" type="text/css" />	
	<title>TEST ThoughtWorks</title>
</head>
<body>
<div id="outputCont" style="display:none;">
	<span id="offset"> </span> <br/>
	mouseX : <span id="mouseX"> </span> | 	mouseY : <span id="mouseY"> </span> <br/>	
	ColWidth : <span id="clientX"> </span> <br/>	
	colmnX : <span id="colmnX"> </span> | colmnY <span id="colmnY"> </span> 
</div>

<form name="myForm" action="#" method="post">
	
	<div class="container" id="mainCont">
	
		<div class="coloumn">
		
			<div class="widgetDIV">
				<h1 id="header_0"> HTML Widget 0</h1>
				<div class="content">
					all html contents comes here 0				
					<p>
						Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex 
					</p>
					<p class="formWrapper">
						<span class="lblWrapper">
							<label for="fname"> First Name :  </label>
							<input type="text" name="fname" id="fname" value="" placeholder="Enter name" />
						</span>
						<span class="lblWrapper">
							<label for="email"> Email Address :  </label>
							<input type="text" name="email" id="email" value="" placeholder="Enter email" />
						</span>
						<span class="lblWrapper">						
							<input type="submit" name="submit" value="Submit" />
						</span>
					</p>					
					<p>
						Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex 
					</p>					
				</div>
			</div>

			<div class="widgetDIV">
				<h1> HTML Widget 1</h1>
				<div class="content">
					<p>
						SAN FRANCISCO - Zipping around on a motorcycle can be fun, but being in a downpour or an accident on one is not. Driving a car is safer and more comfortable, but traffic and parking can be annoying. 
					</p>					
					<img src="images/logo.jpg" class="img" alt="some image" />					
				</div>
			</div>
			
			<div class="widgetDIV">
				<h1> HTML Widget 2</h1>
				<div class="content">
					<p>	
					all html contents comes here
					Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nu
					</p>
						<ul>
							<li> list 1 </li>
							<li> <a href="#"> linked list </a> </li>
							<li> list 3 </li>
							<li> list </li>
					</ul>
				</div>
			</div>
			
		</div>
		
		<div class="coloumn">
		
			<div class="widgetDIV">
				<h1> HTML Widget 3</h1>
				<div class="content"> 
					<p>	
					Claritas est etiam processus dynamicus, qui sequitur mutationem consuetudium lectorum. Mirum est notare quam littera gothica, quam nunc putamus parum claram, anteposuerit litteraru all html contents comes here
					</p>
					<img src="images/weather.jpg" alt="weather" class="imgLeft" />
					<p>
					Get weather forecasts for your hometown and favorite places around the globe.
					</p>
					<input type="button" value="signup" name="signup" />
				</div>
			</div>

			<div class="widgetDIV">
				<h1> HTML Widget 4	</h1>				
				<div class="content">
					<p>	
					ThoughtWorks has been building game-changing software for our clients since 1993. We specialize in creating technology that helps differentiate companies, or that helps make a positive change in the world. We also have a product division,
					</p>
					<ul>
						<li> list 1 </li>
						<li> <a href="#"> list with link </a> </li>
						<li> list 3 </li>
						<li> list </li>
					</ul>				
				</div>
			</div>
			
		</div>
		
		<div class="coloumn">

			<div class="widgetDIV">
				<h1>HTML Widget 5</h1>
				<div class="content">
					all html contents comes here
					<br/>
					building game-changing software for..
				</div>
			</div>
			
			<div class="widgetDIV">
				<h1>HTML Widget 6</h1>
				<div class="content">
					<p>	
						ThoughtWorks has been building game-changing software for our clients since 1993. We specialize in creating technology that helps differentiate companies, or that helps make a positive change in the world. We also have a product division,
					</p>
					<ul class="generalList">
						<li> has been building game-changing </li>
						<li> <a href="#">  change in the world </a> </li>
						<li> have a product </li>
						<li> product division </li>
						<li> list 1 </li>
						<li> <a href="#"> list with link </a> </li>
						<li> list 3 </li>
						<li> list </li>
					</ul>					
				</div>
			</div>
			
			<div class="widgetDIV">
				<h1>HTML Widget 7</h1>
				<div class="content">
					<h1>A different Header</h1>
					 vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent lup			
					asdada
					<br/>
				</div>
			</div>
		
		</div>
		
		<div class="clear"></div>
		
	</div>

</form>


<script type="text/javascript"> 

$(document).ready(function(){
	
	var columnX = []; // store the X start and end pos of all coloumns, .length()-1 will be the no.of coloumns, e.g. if 3 coloumn layout [ 0 , 100 , 200, 300 ]
	var columns = []; // Store Ypos of all the widgets (div.widgetDIV) inside each coloums, eg > 3 coloumn layout = [ [10 , 20] , [12 , 34] , [32 , 11] ]
	var colObjs = {}; //Store both the colomnX and Columns/Sections
	var mainCont = document.getElementById("mainCont"); // flexible main container, acts as a view port. all sections must be placed within this container.
	var mainContX = mainCont.offsetLeft; // capture the initial mainCont X pos for later reference
	var mainContY = mainCont.offsetTop; //capture the initial mainCont Y pos 
	var colNo = ""; // aglobal colNo (within the WIdgetMaker function), this is needs to accessible during mousemove. colNo will be a number, e.g. nth coloumn
	var sectionNo = ""; // same as ColNo. 
	var startDrag = false; // global boolean value to init any other private functions during start drag process
	var tempPlaceHolder = ""; // will contain a div elem acting as a "tempPlaceHolder"  the dotted lines to know where the dragged elem will be placed.
	var currElem = ""; // to access the current elem in action.
	
	//This is a blank dummy, which will be dragged instead of the selected widget/div itself. (mousemove takes a lot of time while dragging the entire widget elem)
	var sectionHolder = document.createElement("div"); 
		sectionHolder.className = "sectionHolder";
		sectionHolder.innerHTML = "";
	
	//A utility function to generate HTML elements based on attributes/parameters passed as objs.
	var GenerateElem = function(opts){
		var elemObj = "";			
		for(var i in opts){
			if(i == "type"){
				elemObj = document.createElement(opts[i]);
			}
			else if(i == "class"){
				elemObj.className = opts[i];
			}
			else{
				elemObj.setAttribute(i, opts[i]);				
			}						
		}			
		return elemObj;			
	}
	
	//Acts like a constructor to create new tempPlaceHolder DIV once dragging of a new elements starts, Any Old tempPlaceHolder div will not available.
	var PlaceHolder = function(){
		var placeHolder = document.createElement("div");
		placeHolder.className = "tempPlaceHolder";
		return placeHolder;
	}
	
	/* --------------------
		Refreshes all the column Xpos and section Ypos (co-ordinates) after each drag-drop or change in widget positions.
		 - Also helps in updating the positions when the window is resized or the MainContainer div is resized.
	---------------------------- */
	var getWidgetPos = function(){
		
		columns = [];
		columnX = [];
		mainContX = mainCont.offsetLeft;
		mainContY = mainCont.offsetTop;
		
		$("div.coloumn").each(function(i, obj){							
			
			columnX.push(mainContX + obj.offsetLeft);
			
			var contY =  [];
			var containers = $(obj).find("div.widgetDIV");
			var contLength = $(containers).length;
			
			$(containers).each(function(k , elem){
				$(elem).attr("id" , "widget_"+i+"_"+k); //setting some id for the sake of uniqueness. 'i' will be the colomn no and 'k' will be section no
				contY.push(elem.offsetTop + mainContY);	
				if(k == contLength -1){
					contY.push(parseInt(contY[k] + elem.offsetHeight/3, 10));
				}
			});				
			columns.push(contY);
			
		});
		
		columnX.push(mainCont.offsetWidth + mainContX);
		
		colObjs = { 
				"columnX" : columnX ,
				"columns" : columns 
			}
			
		return colObjs;
	}

	var initWidgets = function(){			
		
		var that = this; //just in case if we want to access any of the below vars inside an inner function.
		
		var closeElem = ""; //ready to create a closeBtn for each widget
		var toggleElem = ""; //ready to create a slidetoggle btn for each widget
		var expandElem = ""; //ready to create expand btn
		var isLarge = false; // setting to false, as the widget is not resized yet.
					
		/*-----
			All event handlers are assigned in the below iteration for each coloumn.
			iterate using jquery through each of the div which has class as "coloumn".
			TODO : can pass which "class" needs to treated as "coloumns" during the init() function.
		----*/
		$("div.coloumn").each(function(i, obj){				
			
			var containers = $(obj).find("div.widgetDIV");
			var header = ""; 
			
			$(obj).attr("id" , "column_"+i);	
				
				// All event handlers are assigned in the below iteration for each widgetDIV.
				$(containers).each(function(k , elem){			
					
					header = $(elem).find("h1")[0];	//capture the first header only, rest <h1> needs to be ignored.
					
					closeElem = new GenerateElem({ "type" : "span" , "class" : "close"}	);
					closeElem.innerHTML = "Remove";						
					toggleElem = new GenerateElem({ "type" : "span" , "class" : "toggle"});						
					toggleElem.innerHTML = "Toggle";
					expandElem = new GenerateElem({ "type" : "span" , "class" : "expand"})
					expandElem.innerHTML = "Expand";
					
					//Add the closeBtn, toggleBtn and expandBtn inside the first header <h1> only.
					header.appendChild(toggleElem);					
					header.appendChild(expandElem);
					header.appendChild(closeElem);
					
					
					$(header).on({						
						"mousedown" : function(e){
								e.stopPropagation(); 									
								initDrag(e, elem);
						}
					});
					
					//Remove the current widget from DOM
					$(closeElem).on({						
						"mousedown" : function(e){
								e.stopPropagation(); //do not want any other event to be called other than this, e.b > the event handlers in <h1> element.
								$(elem).remove();
						}
					});
					
					//Enable slide toggle of the respective WidgetElem
					$(toggleElem).on({						
						"mousedown" : function(e){
								e.stopPropagation();
								$(elem).find(".content").slideToggle("medium",  function(){
									//slide is over,
								});
						}
					});
					
					
					$(expandElem).on({						
						"mousedown" : function(e){
							e.stopPropagation();
							var obj = this;
							
							if(!isLarge){
								
								isLarge = true;	
								
								obj.innerHTML = "contract";
								$(elem).addClass("expand");
								elem.style.position = "absolute";
								elem.style.width = "100%";
								elem.style.height = "100%";
								elem.style.left = 0;
								elem.style.top = 0;
								$(elem).find("span.toggle").hide();	//do not want slide functionality now.
								$(elem).find(".content").show();	// show the content if it was hidden previsouly.								
								$(elem).find("h1").off("mousedown"); // disable the drag functionality when in expand mode								
							}
							else{

								isLarge = false;

								obj.innerHTML = "expand";
								$(elem).removeClass("expand");
								$(elem).find("span.toggle").show();	
								elem.style.position = "relative";
								elem.style.width = "auto";
								elem.style.height = "auto";
								elem.style.left = "auto";
								elem.style.top = "auto";
								//enable the dragfunctionality once again.
								$(elem).find("h1").on("mousedown" , function(e){
									e.stopPropagation();
									initDrag(e, elem);
								});
								
							}									
						}
					});
				
				});		
		});
		
		function initDrag(e, elem){	
			
			// getCilmNo will return the colomn no based on the mouse.X, e.g > if i == 1, then mouse.X is in coloumn_1 .
			var getColmnNo = function(mEventX){
				//console.log("col =="+colObjs.columnX);		
				for(var i=0; i<colObjs.columnX.length; i++){
					//console.log(colObjs.columnX[i+1]);
					if(mEventX > colObjs.columnX[i] && mEventX < colObjs.columnX[i+1]){
							//console.log("in column "+i+" : "+colObjs.columnX[i]);
							return i;
					}
				}

			}
			
			//Will return the section position based on the respective colomn no (coloum_no passed from above), 
			var getSectionNo = function(mEventY , colNo){
				//console.log("colNo = "+colObjs.columns[colNo]);
				document.getElementById("mouseY").innerHTML = mEventY;
				if(typeof colNo == "number"){
					for(var m=0; m<colObjs.columns[colNo].length; m++){
						//console.log(colObjs.columnX[m+1]);
						if(mEventY > colObjs.columns[colNo][m] && mEventY < colObjs.columns[colNo][m+1]){
								//console.log("in column "+i+" : "+colObjs.columnX[i]);
								return m;
						}
					}	
				}			

			}	
			
			colObjs = getWidgetPos(); // ready to start dragging, get the latest positions first.
			
			//document.getElementById("colmnY").innerHTML = colObjs.columns[0]; //testing purpose
			tempPlaceHolder = new PlaceHolder(); // init a New palceholder div
			
			currElem = elem; //elem will now be available to outside functions as well,
			
			//create a local var for storing the init values and positions of the selected element.
			var elemObjs = {
					"elem" : elem,
					"mouseX" : e.clientX,
					"mouseY" : e.clientY,
					"elemX" : (elem.style.left == "")? 0 : parseInt(elem.style.left , 10),
					"elemY" : (elem.style.top == "")? 0 : parseInt(elem.style.top , 10)
			}
			
			//Actual mousemove function starts here .. 		
			$(document).bind("mousemove", function(e){
				
				if(!startDrag){
					
					//set all these only one time.						
					$(elem).addClass("transaparent");
					
					sectionHolder.style.height = elem.offsetHeight+"px";
					sectionHolder.style.width = elem.offsetWidth+"px";
					sectionHolder.style.position = "absolute";
					sectionHolder.style.left = elem.offsetLeft+"px";
					sectionHolder.style.top = elem.offsetTop+"px";
					sectionHolder.style.zIndex = 1000;
					
					$(currElem).before(sectionHolder);

					elemObjs.elemX = elem.offsetLeft;
					elemObjs.elemY = elem.offsetTop;

					tempPlaceHolder.style.height = sectionHolder.style.height;						

					//Ready to remoce the "mousemove" functionality as soon as the mouse is up,
					
					$(document).bind("mouseup" , function(e){
						
						$(document).unbind("mousemove");
						
						//console.log("mouse move..stopped");
						
						elem.style.zIndex = 0;
						$(elem).removeClass("transaparent");							
						$(sectionHolder).remove();						
						$(tempPlaceHolder).replaceWith($(currElem)); //Actual replacment of the selected elem with the temp tempPlaceHolder comes here.
						tempPlaceHolder = new PlaceHolder(); // create a nee placeholder for next drag/mousemove event
						
						startDrag = false;  
						
					});
				
				}
				
				startDrag = true;
				
				colNo = getColmnNo(e.pageX); //get the current Coloumn No in which the mouse the is in.
				sectionNo = getSectionNo(e.pageY  , colNo); // get the section no based on the coloumn.
				//console.log("colNo = "+colNo+"sectionNo = "+sectionNo);
				
				sectionHolder.style.left = (e.clientX + elemObjs.elemX ) - elemObjs.mouseX+"px";
				sectionHolder.style.top = (e.clientY + elemObjs.elemY) - elemObjs.mouseY+"px";
							
				if(typeof colNo == "number"  && typeof sectionNo == "number"){
					//which means both colNo and section No are present, so place the palceholder just above the section no
					var ID = $("#column_"+colNo).find(".widgetDIV")[sectionNo]; // get the widgetDIV in which the mouse is hovering, based on the children arrays.
					//document.getElementById("offset").innerHTML = $(ID).attr("id") +"sectionNo = "+sectionNo; //testing
					$(ID).before(tempPlaceHolder);	
					
				}
				else if(typeof colNo == "number") {
					//this means that the mouse is in a coloumn but does not have any section targeted, which means that we need to append after the last section
					$("#column_"+colNo).append(tempPlaceHolder);
					//console.log("move at the end of col : "+colNo);	
				}
				else{
					//Mouse is out of the mainCont itself, 
					//TODO : margins is an issue.
					//console.log("not moved to appropriate position"); 
					elem.style.left = 0;
					elem.style.top = 0;
				}
				
			});
		
		}

	}();	
	
	/*  OUTPUT 	FOR TESTING PURPOSE ONLY
	
		var colm = document.getElementById("column_0");
		window.addEventListener("mousemove", function(e){		
			//document.getElementById("mouseX").innerHTML = e.pageX - k.offsetLeft;
			//document.getElementById("mouseY").innerHTML = e.pageY - k.offsetTop;
			//document.getElementById("clientX").innerHTML = colm.offsetWidth;
			//document.getElementById("colmnX").innerHTML = colObjs.columnX;
			//document.getElementById("colmnY").innerHTML = colObjs.columns[0];
			//document.getElementById("mouseX").innerHTML = e.pageX;
			document.getElementById("mouseY").innerHTML = e.pageY;
			//document.getElementById("sectionHolder").innerHTML = document.getElementById("sectionHolder").offsetLeft;		
			
		});
	*/
});

</script>

</body>
</html>
